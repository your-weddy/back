<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:image/x-icon;,">
    <title>홈 화면</title>
</head>
<body>
<h1>홈 화면에 오신 것을 환영합니다!</h1>
<p>이 페이지는 카카오 로그인 후 리다이렉트되는 홈 화면입니다.</p>

<script>
    // 페이지 로드 후 백엔드로 GET API 요청을 보냄
    window.onload = function() {
        console.log('시작:');
        fetchUserInfo();
    };

    // 사용자 정보 요청 함수
    function fetchUserInfo() {
    console.log('시작:');

        fetch('http://localhost:8080/auth/userinfo', {
            method: 'GET',
            credentials: 'include'  // 쿠키를 함께 전송
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            } else if (response.status === 4011) {
                console.log('4011 발생');
                // 401 에러가 발생하면 refresh 요청을 보냄
                return refreshAccessToken();
            }
            throw new Error('네트워크 응답이 올바르지 않습니다.');
        })
        .then(data => {
            console.log('응답 데이터:', data);
            // 데이터 확인 후 처리 (예: 사용자 정보를 화면에 표시)
        })
        .catch(error => {
            console.error('API 요청 오류:', error);
        });
    }

    // 401 에러 발생 시 refresh 토큰 요청 함수
    function refreshAccessToken() {
        console.log("Refresh token 요청 중...");
        return fetch('http://localhost:8080/auth/regenerate-token', {
            method: 'GET',
            credentials: 'include'  // 쿠키를 함께 전송
        })
        .then(response => {
            if (response.ok) {
                // refresh 성공 시 사용자 정보 다시 요청
<!--                fetchUserInfo();-->
            } else {
                throw new Error('Refresh 토큰이 만료되었습니다. 로그인 해주세요.');
            }
        })
        .catch(error => {
            console.error('Refresh 요청 오류:', error);
        });
    }
</script>
</body>
</html>
